liveChat.api={toggleFloatingBoxVisibility:function(a){a.find(".newMessageChatBox").toggle(),a.find(".chatBoxMessages").toggle(),a.find(".sndBtn").toggle()},getContactFromCache:function(a){for(var b=0;b<liveChat.contactsList.length;b++)if(liveChat.contactsList[b].id==a||liveChat.contactsList[b].display_name==a)return liveChat.contactsList[b];return!1},resetFloatingBoxPointers:function(a){liveChat.filesNumCB[a]=0,liveChat.lastSenderBox[a]=0,liveChat.lastTimeBox[a]=0,liveChat.pages[a]=1,liveChat.scrollsHeightBefore[a]=0},noUserFound:function(){var a="<center><b>{{text_no_user_found}}</b></center>";Mustache.parse(a);var b=Mustache.render(a,{text_no_user_found:liveChat.settings.texts.noContactsFound});$(".contacts-list").append(b)},setOpenedBox:function(a){localStorage.setItem("id",a.id),localStorage.setItem("display_name",a.display_name),localStorage.setItem("image",a.image),localStorage.setItem("openedBox",1),liveChat.helpers.setCookie("window",1,10)},getOpenedBoxData:function(){if(!liveChat.api.isOpenedBoxSet())return!1;var a={id:localStorage.getItem("id"),display_name:localStorage.getItem("display_name"),image:localStorage.getItem("image"),openedBox:localStorage.getItem("openedBox")};return a},isOpenedBoxSet:function(){var a=localStorage.getItem("openedBox");return a&&$.trim(a)?!0:!1},renderMessages:function(a,b,c,d){liveChat.helpers.setDateNow(),c.hasClass("jspScrollable")&&(c=c.find(".jspPane")),liveChat.api.data.getMessagesWith(a.id,!1).done(function(e){if(c.length>1&&(c=c.first()),c.parent().find("#spinner"+a.id).remove(),e.length){for(var f=0;f<e.length;f++)e[f].user_sender==a.id?liveChat.api.renderMessage(c,a.display_name,a.image,e[f].message,e[f].m_time,a.id,b,!1):liveChat.api.renderMessage(c,null,null,e[f].message,e[f].m_time,null,b,!1);d&&$(c).scrollTop(c[0].scrollHeight-liveChat.scrollHeightBefore),b?liveChat.pages[a.id]++:liveChat.page++}else $(c).off();liveChat.$body.trigger("liveChat.messagesRendered",[a,e,b,c,d])}.bind(this))},isUserOnline:function(a){return $("#round"+a).length?!$("#round"+a).hasClass("grayRound"):!1},resetNewMessagesCountFromUser:function(a){var b=$("body").find("#newMessagesNum"+a+", #newMessagesNumChatBox"+a);$("body").find("#newMessagesNum"+a).hide(),liveChat.api.stopTittleAlert(),b.length&&b.empty().html(0).css("visibility","hidden"),liveChat.api.data.markAllMessagesAsReadFrom(a).done(function(a){liveChat.api.stopTittleAlert()}),liveChat.$body.trigger("liveChat.newMessagesCountReset",[a])},renderMasterChat:function(a){liveChat.helpers.setDateNow(),liveChat.page=1;var b=liveChat.settings.templates.chat_box_content,c={other_user:{display_name:a.display_name,last_online_full_date:"",last_online_friendly_date:"",user_id:a.id},messages:"",chat_title:Mustache.render(liveChat.settings.texts.chattingWith,{display_name:a.display_name}),text_search_messages:liveChat.settings.texts.searchMessagesInConversation,text_user_is_writing:Mustache.render(liveChat.settings.texts.userIsWriting,{display_name:a.display_name}),text_file_being_uploaded:liveChat.settings.texts.fileBeingUploaded};Mustache.parse(b);var d=Mustache.render(b,c),e=$(".vg-chat_chat_box").first();e.empty().append(d);var f=e.find("#messages"+a.id).first();f.user_id=a.id,f.display_name=a.display_name,f.image=a.image,liveChat.api.renderMessages(a,!1,f),$(f).on("scroll",function(){liveChat.api.initInfiniteScrollOnMainChat(a,f)}),liveChat.api.isUserOnline(a.id)?e.find(".lastOnline").empty().text("now").attr("title",new Date):liveChat.api.data.getUserLastOnline(a.id,function(a){e.find(".lastOnline").empty().text(a.friendly_time).attr("title",a.full_time)}),e.find("#downArrow").click(function(){if(liveChat.searchMax>0&&liveChat.searchNum<liveChat.searchMax){var a=$(".messageBox"),b=$(a[0]).find(".oneMessage");a[0].scrollTop+=parseInt($(b[liveChat.searchNum-1]).height())+15;var c=$(b[liveChat.searchNum-1]).find("div");$(c[1]).removeClass("searchDivYellow");var c=$(b[liveChat.searchNum]).find("div");$(c[1]).addClass("searchDivYellow"),liveChat.searchNum++}}),e.find("#upArrow").first().click(function(){if(liveChat.searchMax>0&&liveChat.searchNum>1){var a=$(".messageBox"),b=$(a[0]).find(".oneMessage");a[0].scrollTop-=parseInt($(b[liveChat.searchNum-2]).height())+15;var c=$(b[liveChat.searchNum-1]).find("div");$(c[1]).removeClass("searchDivYellow");var c=$(b[liveChat.searchNum-2]).find("div");$(c[1]).addClass("searchDivYellow"),liveChat.searchNum--}}),liveChat.api.resetNewMessagesCountFromUser(a.id);var g=e.find("#rightSearch").first();g.user_id=a.id,g.display_name=a.display_name,g.image=a.image,g.on("keyup",function(){var b=$(this).val(),c={id:g.user_id,display_name:g.display_name,image:g.image};liveChat.delay(function(){""==b.trim()?($("#upArrow").hide(),$("#downArrow").hide(),liveChat.helpers.setDateNow(),liveChat.page=1,$(f).empty(),liveChat.api.renderMessages(c,!1,$(f)),$(f).on("scroll",function(){liveChat.api.initInfiniteScrollOnMainChat(a,f)})):($("#upArrow").show(),$("#downArrow").show(),liveChat.helpers.setDateNow(),liveChat.page=1,$(f).empty(),liveChat.api.searchMessages(b,c.id,c.display_name,c.image))},800)}),liveChat.textareaHandler(a.id,liveChat.settings.current_user_id,e,!1);var h=e.find(".send-message-trigger").first();h.to=a.id,$(h).click(function(){liveChat.api.startSendingMessage(e,!1)}),liveChat.api.stopTittleAlert(),liveChat.api.setOpenedBox(a),liveChat.$body.trigger("liveChat.masterChatRendered",[a])},initInfiniteScrollOnMainChat:function(a,b){if(0==$(b).scrollTop()){var c='<div class="spinner" id="spinner'+a.id+'"> <div class="rect1"></div> <div class="rect2"></div> <div class="rect3"></div> <div class="rect4"></div> <div class="rect5"></div> </div>';$(b).prepend(c),liveChat.scrollHeightBefore=b[0].scrollHeight,liveChat.api.renderMessages({id:a.id,display_name:a.display_name,image:a.image},!1,$(b),!0)}},sendMessage:function(a,b){liveChat.sockets.sendMessage(a,b),$(".contact-"+b).each(function(){var a=jQuery(this);a.parent().prepend(a)}),$("#time"+b).empty().html("now");var c=$("#time"+b),d=new Date,e=[[d.getFullYear(),liveChat.helpers.AddZero(d.getMonth()+1),liveChat.helpers.AddZero(d.getDate())].join("-"),[liveChat.helpers.AddZero(d.getHours()),liveChat.helpers.AddZero(d.getMinutes()),liveChat.helpers.AddZero(d.getSeconds())].join(":")].join(" ");c.length&&(c[0].last_msg_time=e),$("#messages"+b).length&&liveChat.api.renderMessage($("#messages"+b),null,null,a,e,null,!1,!0),$("#chatBox"+b).find(".chatBoxMessages").length&&liveChat.api.renderMessage($("#chatBox"+b).find(".chatBoxMessages"),null,null,a,e,null,!0,!0),liveChat.api.data.saveMessage(b,a),liveChat.$body.trigger("liveChat.messageSaved",[b,a])},renderMessage:function(a,b,c,d,e,f,g,h){b||(b=liveChat.settings.current_user_display_name),c||(c=liveChat.settings.current_user_avatar),f||(f=liveChat.settings.current_user_id);var i=f==liveChat.settings.current_user_id?"my":"other",j=g?"."+i+"MessageTextChatBox":"."+i+"MsgDiv",k="."+i+"Text",d=$.emoticons.replace(d),d=liveChat.helpers.replaceImageShortcode(d),l=g?liveChat.lastSenderBox[f]:liveChat.lastSender,m=g?liveChat.lastTimeBox[f]:liveChat.lastTime;if(l==f&&liveChat.lastTime&&e.slice(0,16)===m.slice(0,16)){var n=$(a).find(g?".masterMsgDiv":".oneMessage"),o=$(n[h?n.length-1:0]).find(j),p=g?o[0]:$(o[0]).find(k);h?$(p).append(d+"<br/>"):$(p).prepend(d+"<br/>")}else{if(g?(liveChat.lastSenderBox[f]=f,liveChat.lastTimeBox[f]=e):(liveChat.lastSender=f,liveChat.lastTime=e),g)var q='<div class="masterMsgDiv"><div class="nameTimeChatBox '+i+'nameTimeChatBox"><span class="nameChatBoxO">{{display_name}}</span><span title="{{full_date}}" class="timeChatBoxO">{{friendly_date}}</span></div><div class="'+i+'MessageTextChatBox">{{{message}}}</div></div>';else var r="my"===i?"":'<img src="{{image_url}}" class="'+i+'Image">',s="my"===i?'<img src="{{image_url}}" class="'+i+'Image">':"",q='<div class="oneMessage">'+r+'<div class="'+i+'MsgDiv"><span class="'+i+'SpanName">{{display_name}}</span><span class="'+i+'SpanTime" title="{{friendly_date}}">{{full_date}}</span><div class="'+i+'Text">{{{message}}}</div></div>'+s+"</div>";var t={image_url:c?c:liveChat.settings.defaultAvatarUrl,display_name:b,full_date:e.slice(0,4)+"/"+e.slice(5,7)+"/"+e.slice(8,10)+" | "+e.slice(11,16),friendly_date:liveChat.helpers.findDifBig(e),message:d};Mustache.parse(q);var u=Mustache.render(q,t);h?$(a).append(u):$(a).prepend(u)}$(a).first()[0].scrollTop=$(a).first()[0].scrollHeight},renderContacts:function(a,b,c){var d=liveChat.settings.templates.contacts;Mustache.parse(d),$.each(a,function(b,c){a[b].image=a[b].image?a[b].image:liveChat.settings.defaultAvatarUrl,a[b].friendly_m_time=a[b].m_time?liveChat.helpers.findDif(a[b].m_time):"",a[b].show_new_msg_label=function(){return a[b].new_messages>0?"":"hidden"}});var e=Mustache.render(d,{contacts:a});$(b).html(e),$(b).each(function(){var b=jQuery(this),d=b.data("open");if(!d)return!0;if(c)if("master_chat"===d){var e=$.trim(liveChat.helpers.getQueryStringValue("chat_with"));if(e)var f=liveChat.api.getContactFromCache(e);else var f=a[0];$("#left"+f.id).first().active=!0,liveChat.api.isOpenedBoxSet()||liveChat.api.renderMasterChat(f)}else liveChat.api.openPreviouslyOpenedFloatingBoxes();b.children().each(function(){jQuery(this).click(function(){"master_chat"===d?liveChat.api.renderMasterChat(jQuery(this).data()):(liveChat.api.resetFloatingBoxPointers(jQuery(this).data("id")),liveChat.api.openFloatingBox(jQuery(this).data()))})})}),liveChat.sockets.emit("con",liveChat.settings.current_user_id),liveChat.$body.trigger("liveChat.contactsListRendered",[a,b,c])},openFloatingBox:function(a){var b=liveChat.api.getFloatingBoxPosition(),c=b+2*(liveChat.settings.floatingChatBoxWidth+10);if(c>jQuery(window).width())return alert(liveChat.settings.texts.tooManyFloatingBoxesOpened),!1;var d=a,e=liveChat.$floatingChatContainer.find(".contact-"+d.id);e.find(".newMessagesNum").empty().html(0).css("visibility","hidden");var f=$("#chatBox"+d.user_id);f.length?liveChat.api.isFloatingBoxMinized(f)&&liveChat.api.toggleFloatingBoxVisibility(f):liveChat.api.renderFloatingBox(d.id,d.display_name,d.image)},isFloatingBoxMinimized:function(a){return!a.find(".chatBoxMessages").is("visible")},closeChatBox:function(a){liveChat.numOfOpenedBoxes--,$("#chatBox"+a).remove(),liveChat.api.changeChatBoxPosition();var b=liveChat.helpers.getCookie("chatBoxes"),c=b.split("&**&");if(c.length<2)liveChat.helpers.setCookie("chatBoxes","",1e-5);else{for(var d="",e=0,f=0;f<c.length;f++){var g=c[f].split("&*&");if(parseInt(g[0])!=parseInt(a)){var h=g[0]+"&*&"+g[1]+"&*&"+g[2];0==e?(e=1,d+=h):d+="&**&"+h}}liveChat.helpers.setCookie("chatBoxes",d,3e6)}},getFloatingBoxPosition:function(){return(liveChat.numOfOpenedBoxes-1)*liveChat.settings.floatingChatBoxWidth+10},startSendingMessage:function(a,b){var c=a.find("textarea"),d=$.trim(c.val()),e=b?$.trim(a.find(".filesNames").html()):$.trim(a.find("#filesDiv").html());if(d||e){var d=d.replaceAll("\n","<br>").replaceAll("'","&#39;").replaceAll('"',"&#34;");liveChat.api.sendMessage(d,c.data("toUser")),c.val("")}},renderFloatingBox:function(a,b,c){liveChat.numOfOpenedBoxes++,liveChat.pages[a]=1;var d='<div class="vg-chat-widget-wrapper"><div class="chatBox hidden" id="chatBox{{user_id}}" style="right: {{box_position}}px;"><div class="floating-box-header firstLineChatBox lineColorGray"><div class="newMessagesNum-chatBox" id="newMessagesNumChatBox{{user_id}}"  style="visibility: {{new_messages_count_visibility}};">{{new_messages_count}}</div><div class="chatBoxName">{{display_name}}</div><div class="remove glyphicon glyphicon-remove glyphicon-remove-chatBox"></div><div class="spanLine"></div></div><div class="chatBoxMessages"></div><div id="indicatorChatBox{{user_id}}" class="indicator user-typing-indicator">{{text_user_is_writing}}</div><textarea class="newMessageChatBox" id="newMessageChatBox" rows="2" placeholder="{{text_write_message_here}}"></textarea><img class="sndBtn send-message-trigger" src="{{send_button_url}}"><div class="filesNames"></div><div class="loadingDivChatBox" id="loadingDivChatBox{{user_id}}"><center>{{text_file_being_uploaded}}</center><center><div class="modalChatBox"></div></center></div></div></div>';Mustache.parse(d);var e={user_id:a,new_messages_count:0,display_name:b,new_messages_count_visibility:"hidden",send_button_url:liveChat.settings.floatingChatSendButtonUrl,box_position:liveChat.api.getFloatingBoxPosition(),text_user_is_writing:Mustache.render(liveChat.settings.texts.userIsWriting,{display_name:b}),text_write_message_here:liveChat.settings.texts.writeMessageHer,text_file_being_uploaded:liveChat.settings.fileBeingUploaded,image:c?c:liveChat.settings.defaultAvatarUrl},f=Mustache.render(d,e);$("body").append(f),$floatingBox=$("#chatBox"+a).first(),liveChat.api.changeChatBoxPosition(),$floatingBox.removeClass("hidden"),$($floatingBox).data(e),$($floatingBox).find(".remove").data("user-id",a).click(function(){liveChat.api.closeChatBox(jQuery(this).data("user-id"))}),$($floatingBox).find(".floating-box-header").first().data("other-user-id",a).click(function(){var a=jQuery(this),b=a.parent();liveChat.api.toggleFloatingBoxVisibility(b);var c=b.find(".chatBoxMessages").first();c.length&&c.scrollTop(c.scrollHeight),b.removeClass("lineColorNewMessage"),liveChat.api.resetNewMessagesCountFromUser(b.data("other-user-id"))});var g=$($floatingBox).find(".chatBoxMessages").first();liveChat.api.addMessagesToBox(g,a,b,c,!0),liveChat.helpers.scrollToBottom(g);for(var h=0;7>h;h++)setTimeout(function(){liveChat.helpers.scrollToBottom(g)},200*h);g.data({user_id:a,display_name:b,image:c}).on("scroll",function(){var a=jQuery(this),b=a.data();if(0===a.scrollTop()){var c='<div class="spinner" id="spinnerBox'+b.user_id+'"> <div class="rect1"></div> <div class="rect2"></div> <div class="rect3"></div> <div class="rect4"></div> <div class="rect5"></div> </div>';a.prepend(c),liveChat.scrollsHeightBefore[b.user_id]=this.scrollHeight,liveChat.api.addMessagesToBox(this,b.user_id,b.display_name,b.image)}}),liveChat.textareaHandler(a,liveChat.settings.current_user_id,$floatingBox,!0),$($floatingBox).find(".send-message-trigger").first().click(function(){liveChat.api.startSendingMessage(jQuery(this).parent())}),liveChat.api.addFloatingBoxToCookie(a,b,c),liveChat.$body.trigger("liveChat.floatingChatRendered",[e])},displayNewMessagesNotification:function(){liveChat.api.data.getUnreadMessagesCount().done(function(a){parseInt(a)>0&&$.titleAlert(a>1?"("+a+") Nuevos mensajes":"("+a+") Nuevo mensaje")})},addFloatingBoxToCookie:function(a,b,c){var d=liveChat.helpers.getCookie("chatBoxes"),e=a+"&*&"+b+"&*&"+c;if(""===d||" "===d||void 0===d)liveChat.helpers.setCookie("chatBoxes",e,3e6);else{for(var f=0,g=d.split("&**&"),h=0;h<g.length;h++){var i=g[h].split("&*&");if(parseInt(i[0])==a){f=1;break}}0==f&&liveChat.helpers.setCookie("chatBoxes",liveChat.helpers.getCookie("chatBoxes")+"&**&"+e,3e6)}},getPreviouslyOpenedFloatingBoxes:function(){out=[];var a=liveChat.helpers.getCookie("chatBoxes");if(!a||!$.trim(a))return out;for(var b=a.split("&**&"),c=0;c<b.length;c++)out.push(b[c].split("&*&"));return out},openPreviouslyOpenedFloatingBoxes:function(){var a=liveChat.helpers.getQueryStringValue("chat_with");if(a)var b=[liveChat.api.getContactFromCache(a)];else{var c=liveChat.api.getPreviouslyOpenedFloatingBoxes(),b=[];$.each(c,function(a,c){b.push({id:c[0],display_name:c[1],image:c[2]})})}$.each(b,function(a,b){liveChat.api.openFloatingBox(b)})},changeChatBoxPosition:function(){for(var a=$(".chatBox"),b=0;b<a.length;b++){var c=b*liveChat.settings.floatingChatBoxWidth+10;$(a[b]).css("right","0px"===liveChat.$body.find("#chatOpen").css("right")?c:c+205+"px")}liveChat.$body.trigger("liveChat.floatingBoxesPositionsUpdated",[a])},acceptNewUserConnection:function(a){liveChat.api.data.isConnectedWith(a).done(function(b){if(parseInt(b)>0){liveChat.acceptedConnection(b);var c={my:liveChat.settings.current_user_id,to:b};liveChat.sockets.emit("okNewCon",c),liveChat.$body.trigger("liveChat.newUserConnectionAccepted",[a])}})},searchContacts:function(a,b,c){if("first_letter"===b)var d=liveChat.api.data.searchContactsByFirstLetter(a,c);else var d=liveChat.api.data.searchContacts(a,c);d.done(function(a){liveChat.api.renderContactsSearchResults(a,c)})},renderContactsSearchResults:function(a,b){$(".contacts-list").empty(),a.length<1?liveChat.api.noUserFound():liveChat.api.renderContacts(a,liveChat.$body.find(".contacts-list")),liveChat.$body.trigger("liveChat.contactsSearchResultsRendered",[a])},searchMessages:function(a,b,c,d){liveChat.helpers.setDateNow(),$(".messageBox").off(),liveChat.api.data.searchMessages(a,b,c,d).done(function(a){$(".messageBox").empty(),liveChat.searchMax=0,liveChat.searchNum=1;for(var e=0;e<a.length;e++)liveChat.searchMax++,a[e].user_sender==b?liveChat.api.renderMessage($(".messageBox"),c,d,a[e].message,a[e].m_time,b,!1,!1):liveChat.api.renderMessage($(".messageBox"),null,null,a[e].message,a[e].m_time,null,!1,!1);if(liveChat.searchMax>0){var f=$(".messageBox").find(".oneMessage"),g=$(f[0]).find("div");$(g[1]).addClass("searchDivYellow")}var h=$(".messageBox");h[0].scrollTop=0})},addMessagesToBox:function(a,b,c,d,e){liveChat.helpers.setDateNow(),liveChat.api.data.getMessagesWith(b,!0).done(function(f){$("#spinnerBox"+b).length&&$("#spinnerBox"+b).remove();for(var g=0;g<f.length;g++)f[g].user_sender==b?liveChat.api.renderMessage(a,c,d,f[g].message,f[g].m_time,b,!0,!1):liveChat.api.renderMessage(a,null,null,f[g].message,f[g].m_time,b,!0,!1);e&&$(a).scrollTop($(a).height()),liveChat.pages[b]++})},stopTittleAlert:function(){liveChat.api.data.getUnreadMessagesCount().done(function(a){0==parseInt(a)&&$.titleAlert("New message",{duration:1,stopOnFocus:!1})})}};