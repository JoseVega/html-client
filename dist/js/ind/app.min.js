var liveChat={widgetsKeys:["contacts_list","chat_box","floating_chat"],filesNumCB:[],settings:{},pages:[],scrollsHeightBefore:[],numOfOpenedBoxes:0,maxLeft:100,searchMax:0,searchNum:1,filesNum:0,page:0,scrollHeightBefore:0,lastSender:0,lastTime:0,lastSenderBox:[],lastTimeBox:[],now:null,strDateTime:null,yearNow:null,monthNow:null,dateNow:null,hoursNow:null,minutesNow:null,init:function(a){var b={socketServerUrl:"",siteId:"",clientUrl:"",backendUrl:"",current_user_id:0,current_user_avatar:"",current_user_display_name:"",current_user_username:"",floatingChatBoxWidth:245,texts:{fileBeingUploaded:"The file is uploading...",contactsMobileDropdownTitle:"Contacts",noContactsFound:"Users not found",chattingWith:"Chat with {{display_name}}",writeMessageHere:"Write your message here",searchContacts:"Search contacts",searchMessagesInConversation:"Search in conversation",userIsWriting:"{{display_name}} is writing...",tooManyFloatingBoxesOpened:"You have too many chats opened, please close some to be able to open new ones.",hoursAgo:"{{unit}} hours ago",hourAgo:"{{unit}} hour ago",minutesAgo:"{{unit}} minutes ago",minuteAgo:"{{unit}} minute ago",daysAgo:"{{unit}} days ago",monthsAgo:"{{unit}} months ago",yesterday:"Yesterday",today:"Today",now:"Now",nonExistentContacts:"Your contacts list is empty."},defaultAvatarUrl:"",env:"prod",avFiles:[".doc",".dot",".docx",".dotx",".xls",".xlsx",".xlsm",".ppt",".pot",".pps",".pptx",".pptm",".potx",".potm",".pub",".rar",".zip",".7zip",".html",".css",".js",".json",".gz",".tz",".7z",".tar",".jpeg",".jpg",".tiff",".gif",".bmp",".png",".webp",".psd",".psp",".cpt",".svg",".ai",".pdf",".txt",".csv",".php",".mp4",".mp3",".avi",".flv",".wmv",".mov",".rmvb",".mpg",".mpeg",".m4v",".3gp",".wma",".m4a",".mp2",".aac",".htm",".log"]};return b.templates={floating_chat:'<img src="{{clientUrl}}imgs/chatOpen.png" class="chatOpen" id="chatOpen"><div class="vg-chat vg-chat_floating_chat"><div class="contacts-list" data-open="floating_box"></div><input type="text" id="search-chat" class="form-control contacts-search" placeholder="'+b.texts.searchContacts+'"><div class="glyphicon glyphicon-search" id="glyphiconSearch-fixed"></div></div>',required_elements:'<audio id="chatSound" src="{{newMessageSoundUrl}}"></audio> <a class="image-popup-no-margins" style="display: none;"><img id="image-popup" width="0" height="0"></a>',contacts_list:' <h3 class="mobile-contacts-toggle down-triangle">'+b.texts.contactsMobileDropdownTitle+'</h3><div class="vg-chat vg-chat_contacts_list"><input type="text" class="form-control leftSearch contacts-search" placeholder="'+b.texts.searchContacts+'" id="usersSearch"> <span class="glyphicon glyphicon-search" id="searchGlyphicon"></span> <div class="contacts-list" data-open="master_chat"></div> </div>',chat_box:'<div class="vg-chat vg-chat_chat_box"></div>',chat_box_content:'    <b>{{chat_title}}</b>    <input class="rightSearch form-control" id="rightSearch" placeholder="{{text_search_messages}}" type="text">        <span class="glyphicon glyphicon-search" id="glyphiconSearchRight"></span>        <span class="glyphicon glyphicon-arrow-down" id="downArrow"></span>        <span class="glyphicon glyphicon-arrow-up" id="upArrow"></span>        <span class="lastOnline" id="lastOnline{{other_user.user_id}}" title="{{other_user.last_online_full_date}}">{{other_user.last_online_friendly_date}}</span>        <div id="messages{{other_user.user_id}}" class="messageBox">{{messages}}</div>		<div id="indicator{{other_user.user_id}}" class="indicator">{{text_user_is_writing}}</div>		<textarea class="newMessage" id="newMessage" rows="5"></textarea>		<div class="loadingDiv">			<center>{{text_file_being_uploaded}}</center>			<center>				<div class="modal"></div>			</center>		</div>		<button class="btn btn-green send-message-trigger">Enviar</button>		<div class="filesDiv" id="filesDiv"></div>',contacts:'{{#contacts}}<div class="master contact-{{id}}" id="left{{id}}" data-user-id="{{id}}" data-id="{{id}}" data-display_name="{{display_name}}" data-image="{{image}}"><img class="leftImage" src="{{image}}"><div class="grayRound" id="round{{id}}"></div><div class="nameTime"><span class="name">{{display_name}}</span><br><span class="time" id="time{{id}}" title="{{m_time}}">{{friendly_m_time}}</span><div class="newMessagesNum {{show_new_msg_label}}" id="newMessagesNum{{id}}">{{new_messages}}</div></div></div>{{/contacts}}',my_message:'<div class="oneMessage"><div class="myMsgDiv"><span class="mySpanTime" title="{{m_time}}">{{friendly_m_time}}</span><span class="mySpanName">{{user_name}}</span><div class="myText">{{message}}</div></div><img src="{{user_avatar}}" class="myImage"></div>',other_message:'<img src="{{user_avatar}}" class="otherImage"><div class="otherMsgDiv"><span class="otherSpanName">{{user_name}}</span><span class="otherSpanTime" title="{{m_time}}">{{friendly_m_time}}</span><div class="otherText">{{message}}</div></div>'},this.settings=jQuery.extend({},b,a),this.settings.defaultAvatarUrl||(this.settings.defaultAvatarUrl=this.settings.clientUrl+"imgs/default_avatar.png"),this.settings.floatingChatSendButtonUrl||(this.settings.floatingChatSendButtonUrl=this.settings.clientUrl+"imgs/sendbtn.png"),this.settings.newMessageSoundUrl||(this.settings.newMessageSoundUrl=this.settings.clientUrl+"sound/chat_sound.mp3"),this.areRequiredSettingsSet()?(this.loadStylesheet(),this.renderWidgets(),this.cacheElements(),this.clearStorage(),liveChat.helpers.setDateNow(),this.registerReplaceAll(),this.sockets.initIo(),this.findWidget("contacts_list")&&this.initContactsList(!0),this.findWidget("chat_box")&&this.initMasterChat(),this.bindEvents(),this.initEmoticons(),liveChat.api.displayNewMessagesNotification(),this.initImagePopup(),void this.updateMessagesTimesFloatingChat()):!1},initMasterChat:function(){if(liveChat.api.isOpenedBoxSet()){var a=liveChat.api.getOpenedBoxData();liveChat.api.renderMasterChat(a)}},removeLastDirectoryPartOf:function(a){var b=a.split("/");return b.pop(),b.join("/")},loadStylesheet:function(){if($("link#livechat-css").length)return!0;if("dev"===this.settings.env){var a=this.settings.clientUrl.lastIndexOf("/")===this.settings.clientUrl.length-1?this.settings.clientUrl.substring(0,this.settings.clientUrl.lastIndexOf("/")):this.settings.clientUrl,b=this.removeLastDirectoryPartOf(a);$("head").append('<link rel="stylesheet" href="'+b+'/vendor/magnific-popup/dist/magnific-popup.css"/><link rel="stylesheet" href="'+this.settings.clientUrl+'css/bootstrap-glyphicons.css"/><link rel="stylesheet" href="'+this.settings.clientUrl+'css/emotions.css"/><link rel="stylesheet" id="livechat-css" href="'+this.settings.clientUrl+'css/chat.css"/>')}else $("head").append('<link rel="stylesheet" href="'+this.settings.clientUrl+'vendor/libraries.min.css"/><link rel="stylesheet" id="livechat-css" href="'+this.settings.clientUrl+'css/livechat.min.css"/>')},areRequiredSettingsSet:function(){return this.settings.current_user_id&&this.settings.current_user_display_name&&this.settings.current_user_username&&this.settings.socketServerUrl&&this.settings.clientUrl&&this.settings.backendUrl?!0:!1},renderWidgets:function(){$widgetsHolders=$(".vg-chat-widget-holder"),$widgetsHolders.length&&(jQuery("body").hasClass("vg-live-chat-wrapper")||jQuery("body").addClass("vg-live-chat-wrapper"),$widgetsHolders.each(function(){$widget=jQuery(this);var a='<div class="vg-chat-widget-wrapper">'+liveChat.settings.templates[$widget.data("widget")]+"</div>";Mustache.parse(a);var b=Mustache.render(a,liveChat.settings);$widget.replaceWith(b)}),jQuery("body").trigger("liveChat.widgetsRendered"))},openPopUp:function(a){void 0!==jQuery.fn.magnificPopup&&($(".image-popup-no-margins").attr("href",$(a).attr("src")),$("#image-popup").attr("src",$(a).attr("src")),$(".image-popup-no-margins").magnificPopup("open"))},updateMessagesTimesFloatingChat:function(){setInterval(function(){liveChat.helpers.setDateNow();var a=$(".timeChatBox"),b=$(".timeChatBoxO");if(a.length)for(var c=0;c<a.length;c++)$(a[c]).empty().html(liveChat.helpers.findDifBig(a[c].last_msg_time," "));if(b.length)for(var c=0;c<b.length;c++)$(b[c]).empty().html(liveChat.helpers.findDifBig(b[c].last_msg_time," "))},6e4)},bindEvents:function(){this.$body.on("keyup",".contacts-search",this.initUsersSearch),this.$body.on("click",".open-image-lightbox",function(a){a.preventDefault(),liveChat.openPopUp(jQuery(this).find("img"))}),liveChat.sockets.on("write"+liveChat.settings.current_user_id,this.userStartedWriting.bind(this)),liveChat.sockets.on("stopWrite"+liveChat.settings.current_user_id,this.userStoppedWriting.bind(this)),liveChat.sockets.on("dis",this.userWasDisconnected.bind(this)),liveChat.sockets.on("newCon",this.newUserConnected.bind(this)),liveChat.sockets.on("acceptCon"+liveChat.settings.current_user_id,this.acceptedConnection.bind(this)),liveChat.sockets.on(liveChat.settings.current_user_id,this.messageReceived.bind(this)),this.$body.on("click","#contactList",this.floatingChatToggle),this.$body.on("click","#chatOpen",this.floatingChatBarToggle),this.$body.on("click",".mobile-contacts-toggle",function(a){a.preventDefault();var b=jQuery(this),c=b.next(".vg-chat_contacts_list");jQuery(c).slideToggle(),jQuery(b).hasClass("up-triangle")?jQuery(b).removeClass("up-triangle").addClass("down-triangle"):jQuery(b).removeClass("down-triangle").addClass("up-triangle")}),$(window).on("beforeunload",liveChat.api.updateLastOnline),$(document).ready(function(){setInterval(function(){liveChat.api.data.updateLastOnline(),liveChat.updateLastOnline()},3e5)}),$(window).on("focus",function(){this.setActiveStatus(!0)}.bind(this)),$(window).on("blur",function(){this.setActiveStatus(!1)}.bind(this))},setActiveStatus:function(a){this.isActive=a},floatingChatBarToggle:function(){liveChat.$floatingChatContainer.toggle(),"0px"===$(this).css("right")?($(this).css("right","204px"),liveChat.maxLeft=85,liveChat.api.changeChatBoxPosition()):($(this).css("right","0"),liveChat.maxLeft=100,liveChat.api.changeChatBoxPosition())},floatingChatToggle:function(){this.$floatingChatContainer.show(),$("#contactList").hide()},initFloatingChat:function(){liveChat.helpers.setDateNow(),inicialize_master()},initImagePopup:function(){$(".image-popup-no-margins").magnificPopup({type:"image",closeOnContentClick:!0,closeBtnInside:!1,fixedContentPos:!0,mainClass:"mfp-no-margins mfp-with-zoom",image:{verticalFit:!0},zoom:{enabled:!0,duration:300}})},messageReceived:function(a){if(liveChat.helpers.setDateNow(),liveChat.settings.current_user_id===a.from)return!0;if($("#chatSound").get(0).play(),void 0!==$("#messages"+a.from).html()){var b=$("#messages"+a.from),c=b[0].scrollHeight,d=parseInt($(b[0]).scrollTop())+parseInt($(b[0]).height())+100;liveChat.api.renderMessage($("#messages"+a.from),a.display_name,a.image_url,a.msg,this.strDateTime,a.from,!1,!0),d>c&&liveChat.helpers.scrollToBottom($("#messages"+a.from)),$.ajax({type:"POST",dataType:"json",url:liveChat.settings.backendUrl+"?livechat_request=yes&endpoint=read_messages",data:{id:a.from},error:function(a,b,c){},success:function(a){}})}if(void 0===$("#messages"+a.from).html()&&void 0!==$("#chatBox"+a.from).html()&&"none"===$("#chatBox"+a.from).find(".chatBoxMessages").css("display")){$.titleAlert("New message");var e=$("#newMessagesNum"+a.from);if(void 0!==e){var f=$("#newMessagesNum"+a.from).html();f++,$("#newMessagesNum"+a.from).empty().html(f).show()}var e=$("#newMessagesNum-chat"+a.from);if(void 0!==e){var f=$("#newMessagesNum-chat"+a.from).html();f++,$("#newMessagesNum-chat"+a.from).empty().html(f).css("visibility","visible")}$("#chatBox"+a.from).find(".firstLineChatBox").addClass("lineColorNewMessage")}if(void 0!==$("#chatBox"+a.from).html()){var b=$("#chatBox"+a.from).find(".chatBoxMessages"),c=b[0].scrollHeight,d=parseInt($(b[0]).scrollTop())+parseInt($(b[0]).height())+100;if(liveChat.api.renderMessage(b[0],a.display_name,a.image_url,a.msg,this.strDateTime,a.from,!0,!0),d>c)for(var g=0;4>g;g++)setTimeout(liveChat.api.scrollToBottom,200*g,b[0]);"none"!==$("#chatBox"+a.from).find(".chatBoxMessages").css("display")&&$.ajax({type:"POST",dataType:"json",url:liveChat.settings.backendUrl+"?livechat_request=yes&endpoint=read_messages",data:{id:a.from},error:function(a,b,c){},success:function(a){}})}if(void 0===$("#messages"+a.from).html()&&void 0===$("#chatBox"+a.from).html()&&liveChat.api.renderFloatingBox(a.from,a.display_name,a.image_url),void 0!==$(".vg-chat_contacts_list").html()){$("#left"+a.from).parent().prepend($("#left"+a.from)),$("#time"+a.from).empty().append("now");var h=new Date,i=[[h.getFullYear(),liveChat.helpers.AddZero(h.getMonth()+1),liveChat.helpers.AddZero(h.getDate())].join("-"),[liveChat.helpers.AddZero(h.getHours()),liveChat.helpers.AddZero(h.getMinutes()),liveChat.helpers.AddZero(h.getSeconds())].join(":")].join(" "),j=$("#time"+a.from);void 0!==j[0]&&(j[0].last_msg_time=i)}this.isActive||$.titleAlert("New message")},acceptedConnection:function(a){$("#round"+a).removeClass("grayRound").addClass("greenRound"),$("#lastOnline"+a).css("visibility","hidden")},initEmoticons:function(){var a={smile:{title:"Smile",codes:[":)",":=)",":-)"]},"sad-smile":{title:"Sad Smile",codes:[":(",":=(",":-("]},"big-smile":{title:"Big Smile",codes:[":D",":=D",":-D",":d",":=d",":-d"]}};$.emoticons.define(a)},newUserConnected:function(a){a!==liveChat.settings.current_user_id&&liveChat.api.acceptNewUserConnection(a)},userStoppedWriting:function(a){var b=$("#indicatorChatBox"+a);if(void 0!==b[0]){$(b[0]).hide();var c=$("#messages"+a);if(void 0!==c[0]){var d=parseInt($(c[0]).css("height"))+18;$(c[0]).css("height",d)}}var b=$("#indicator"+a);void 0!==b[0]&&$(b[0]).hide()},userStartedWriting:function(a){var b=$("#indicator"+a);if(void 0!==b[0]){$(b[0]).show();var c=$("#messages"+a);if(void 0!==c[0]){var d=parseInt($(c[0]).css("height"))-18;$(c[0]).css("height",d)}}var b=$("#indicatorChatBox"+a);if(void 0!==b[0]){var e=$(b[0]).parent().find("textarea");"none"!==$(e[0]).css("display")&&$(b[0]).show()}},userWasDisconnected:function(a){$("#round"+a).removeClass("greenRound").addClass("grayRound"),$("#roundCB"+a).removeClass("greenRound").addClass("grayRound"),liveChat.helpers.setDateNow();var b=$("#lastOnline"+a);void 0!==b[0]&&($(b[0]).css("visibility","visible").empty().append(liveChat.helpers.findDifLastOnline(this.strDateTime)).attr("title",this.strDateTime.slice(0,4)+"/"+this.strDateTime.slice(5,7)+"/"+this.strDateTime.slice(8,10)+" "+this.strDateTime.slice(11,16)),b[0].time=this.strDateTime)},clearStorage:function(){(""===liveChat.helpers.getCookie("window")||" "===liveChat.helpers.getCookie("window"))&&localStorage.clear()},cacheElements:function(){this.$body=jQuery("body"),this.$widgets=this.$body.find(".vg-chat"),this.$floatingChatContainer=this.$body.find(".vg-chat_floating_chat"),this.$masterChatContainer=this.$body.find(".vg-chat_chat_box")},findWidget:function(a){return this.$body.find(".vg-chat_"+a).length},delay:function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}(),initUsersSearch:function(){var a=$(this).val();liveChat.delay(function(){a&&a.trim()?(liveChat.helpers.setDateNow(),a.length>1?liveChat.api.searchContacts(a,"full",!1):liveChat.api.searchContacts(a,"first_letter",!1)):(liveChat.helpers.setDateNow(),liveChat.initContactsList())},800)},setOpenedUser:function(a){liveChat.api.isOpenedBoxSet()||liveChat.api.renderMessages(a)},renderNonExistentContactsMsg:function(){liveChat.findWidget("chat_box")&&liveChat.$masterChatContainer.empty().append('<p class="vg-chat-non-existent-contacts-message">'+liveChat.settings.texts.nonExistentContacts+"</p>"),liveChat.$body.find(".vg-chat_contacts_list").length&&liveChat.$body.find(".vg-chat_contacts_list").append('<p class="vg-chat-non-existent-contacts-message">'+liveChat.settings.texts.nonExistentContacts+"</p>")},initContactsList:function(a){a||(a=!1),liveChat.api.data.getContacts().done(function(b){return liveChat.contactsList=b,!b||$.isEmptyObject(b)?(liveChat.renderNonExistentContactsMsg(),!0):($(".contacts-list").empty(),liveChat.api.renderContacts(this.contactsList,liveChat.$body.find(".contacts-list"),a),liveChat.$body.find(".vg-chat_contacts_list").css("max-height",jQuery(window).height()),void liveChat.sockets.emit("con",liveChat.settings.current_user_id))}.bind(this))},updateLastOnline:function(){liveChat.helpers.setDateNow(),liveChat.helpers.setDateNow();var a=$(".vg-chat_contacts_list").find(".master");if(a.length)for(var b=0;b<a.length;b++){var c=$(a[0]).find(".time");c&&c[0].last_msg_time&&$(c[0]).empty().html(liveChat.helpers.findDif(c[0].last_msg_time))}var d=$(".lastOnline");d.length&&void 0!==d[0]&&$(d[0]).empty().append(liveChat.helpers.findDifLastOnline(d[0].time));var c=$(".mySpanTime");if(c.length)for(var b=0;b<c.length;b++)$(c[b]).empty().html(liveChat.helpers.findDifBig(c[b].time));var c=$(".otherSpanTime");if(c.length)for(var b=0;b<c.length;b++)$(c[b]).empty().html(liveChat.helpers.findDifBig(c[b].time))},scrolltoDown:function(){$(window).ready(function(){setTimeout(function(){liveChat.helpers.scrollToBottom()},200)})},registerReplaceAll:function(){String.prototype.replaceAll=function(a,b,c){return this.replace(new RegExp(a.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),c?"gi":"g"),"string"==typeof b?b.replace(/\$/g,"$$$$"):b)}},handleFileSelect:function(a,b){a.stopPropagation(),a.preventDefault(),a=a.originalEvent;for(var c,d=a.dataTransfer.files,e=0;c=d[e];e++){if(b){if($(a.target).prop("disabled"))break;liveChat.filesNumCB[a.target.to]++}var f=Math.floor(Date.now()/1e3)+""+liveChat.settings.current_user_id+"_"+e,g=c.name.split(".");if(-1!=liveChat.settings.avFiles.indexOf("."+g[g.length-1])){var h='<span class="fileName" id="{{timestamp}}"><div class="fileLoad"><div class="sk-fading-circle">        <div class="sk-circle1 sk-circle"></div>        <div class="sk-circle2 sk-circle"></div>        <div class="sk-circle3 sk-circle"></div>        <div class="sk-circle4 sk-circle"></div>        <div class="sk-circle5 sk-circle"></div>        <div class="sk-circle6 sk-circle"></div>        <div class="sk-circle7 sk-circle"></div>        <div class="sk-circle8 sk-circle"></div>       <div class="sk-circle9 sk-circle"></div>       <div class="sk-circle10 sk-circle"></div>        <div class="sk-circle11 sk-circle"></div>        <div class="sk-circle12 sk-circle"></div>    </div></div></span>',i={timestamp:f};Mustache.parse(h);var j=Mustache.render(h,i);if(b){var k=$(a.target).parent().find(".filesNames");k.append(j);var l=k.find(".fileName").first()}else{var k=$("#filesDiv");k.append(j);var l=k.find(".fileName").first()}l.newName=f,l.extension=g[g.length-1];var m=new FormData;m.append("label",c.name),m.append("to_user",$(a.target).data("to-user")),m.append("newName",f),m.append("file",c),$.ajax({url:liveChat.settings.backendUrl+"?livechat_request=yes&endpoint=upload",type:"POST",data:m,enctype:"multipart/form-data",processData:!1,contentType:!1}).done(function(a){var c=a.slice(1,a.length-2).split(","),d=c[0].replaceAll('"',""),e=c[1].replaceAll('"',""),f=c[2].replaceAll('"',""),g=c[3].replaceAll('"',""),h="";"png"===e||"jpg"===e||"jpeg"===e||"gif"===e||"bmp"===e?(h='[linked_file="'+d+'" type="image" filename="'+g+'"]',liveChat.api.sendMessage(h,f)):(h='[linked_file="'+d+'" type="file" filename="'+g+'"]',b?liveChat.api.sendMessage(h,f,$("#"+d).parent()):liveChat.api.sendMessage(h,f)),$("#"+d).remove()})}}},handleDragOver:function(a){a.stopPropagation(),a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="copy"},textareaHandler:function(a,b,c,d){d||(d=!1);var e=c.find("textarea");e.data("to-user",a).focusin(function(){data={my:b,to:a},liveChat.sockets.emit("write",data)}).focusout(function(){data={my:b,to:a},liveChat.sockets.emit("stopWrite",data)}).keydown(function(a){13!=a.keyCode||a.shiftKey||a.preventDefault()}).keyup(function(a){if(window.event)var b=window.event.keyCode;else var b=a.keyCode||a.which;a.shiftKey||13!=b||liveChat.api.startSendingMessage(c,d)}.bind(d)).on("dragover",liveChat.handleDragOver).on("drop",function(a){liveChat.handleFileSelect(a,d)})}};